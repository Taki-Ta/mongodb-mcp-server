name: Build Docker Image

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build TypeScript
      run: npm run build
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Generate image metadata
      id: meta
      run: |
        # ç”Ÿæˆé•œåƒæ ‡ç­¾
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          # å¦‚æžœæ˜¯tagï¼Œä½¿ç”¨tagåç§°
          TAG=${GITHUB_REF#refs/tags/}
          echo "tags=mongodb-mcp-server:$TAG,mongodb-mcp-server:latest" >> $GITHUB_OUTPUT
          echo "version=$TAG" >> $GITHUB_OUTPUT
        elif [[ $GITHUB_REF == refs/heads/main ]] || [[ $GITHUB_REF == refs/heads/master ]]; then
          # å¦‚æžœæ˜¯main/masteråˆ†æ”¯
          echo "tags=mongodb-mcp-server:latest,mongodb-mcp-server:main" >> $GITHUB_OUTPUT
          echo "version=main-$(echo $GITHUB_SHA | cut -c1-8)" >> $GITHUB_OUTPUT
        else
          # å…¶ä»–åˆ†æ”¯æˆ–PR
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BRANCH_NAME=${BRANCH_NAME//\//-}  # æ›¿æ¢æ–œæ ä¸ºæ¨ªçº¿
          echo "tags=mongodb-mcp-server:$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "version=$BRANCH_NAME-$(echo $GITHUB_SHA | cut -c1-8)" >> $GITHUB_OUTPUT
        fi
        
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64
        push: false
        tags: ${{ steps.meta.outputs.tags }}
        outputs: type=docker,dest=/tmp/mongodb-mcp-server.tar
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Compress Docker image
      run: |
        # åŽ‹ç¼©é•œåƒæ–‡ä»¶ä»¥å‡å°ä½“ç§¯
        gzip /tmp/mongodb-mcp-server.tar
        
    - name: Get image info
      id: image_info
      run: |
        # èŽ·å–åŽ‹ç¼©åŽçš„æ–‡ä»¶å¤§å°
        SIZE=$(du -h /tmp/mongodb-mcp-server.tar.gz | cut -f1)
        echo "size=$SIZE" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆæ–‡ä»¶å
        FILENAME="mongodb-mcp-server-${{ steps.meta.outputs.version }}-amd64.tar.gz"
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT
        
        # é‡å‘½åæ–‡ä»¶
        mv /tmp/mongodb-mcp-server.tar.gz "/tmp/$FILENAME"
        
    - name: Upload Docker image as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.image_info.outputs.filename }}
        path: /tmp/${{ steps.image_info.outputs.filename }}
        retention-days: 30
        compression-level: 0  # å·²ç»åŽ‹ç¼©è¿‡äº†ï¼Œä¸éœ€è¦å†åŽ‹ç¼©
        
    - name: Create download instructions
      run: |
        cat > download-instructions.md << 'EOF'
        # MongoDB MCP Server Docker é•œåƒä¸‹è½½è¯´æ˜Ž
        
        ## é•œåƒä¿¡æ¯
        - **ç‰ˆæœ¬**: ${{ steps.meta.outputs.version }}
        - **æž¶æž„**: linux/amd64
        - **æ–‡ä»¶å¤§å°**: ${{ steps.image_info.outputs.size }}
        - **æ–‡ä»¶å**: ${{ steps.image_info.outputs.filename }}
        
        ## ä¸‹è½½å’Œä½¿ç”¨æ–¹æ³•
        
        ### 1. ä¸‹è½½é•œåƒæ–‡ä»¶
        è¯·ä»ŽGitHub Actionsçš„Artifactsä¸­ä¸‹è½½é•œåƒæ–‡ä»¶ï¼š${{ steps.image_info.outputs.filename }}
        
        ### 2. åŠ è½½Dockeré•œåƒ
        ```bash
        # è§£åŽ‹é•œåƒæ–‡ä»¶
        gunzip ${{ steps.image_info.outputs.filename }}
        
        # åŠ è½½åˆ°Dockerä¸­
        docker load -i mongodb-mcp-server-${{ steps.meta.outputs.version }}-amd64.tar
        ```
        
        ### 3. è¿è¡Œå®¹å™¨
        ```bash
        # ä½¿ç”¨é»˜è®¤é…ç½®è¿è¡Œ
        docker run -d -p 8000:8000 \
          -e MDB_MCP_CONNECTION_STRING="your_mongodb_connection_string" \
          -e MDB_DB="your_database_name" \
          mongodb-mcp-server:${{ steps.meta.outputs.version }}
        
        # æˆ–è€…ä½¿ç”¨latestæ ‡ç­¾
        docker run -d -p 8000:8000 \
          -e MDB_MCP_CONNECTION_STRING="your_mongodb_connection_string" \
          -e MDB_DB="your_database_name" \
          mongodb-mcp-server:latest
        ```
        
        ### 4. çŽ¯å¢ƒå˜é‡è¯´æ˜Ž
        - `PORT`: æœåŠ¡ç«¯å£ (é»˜è®¤: 8000)
        - `MDB_MCP_CONNECTION_STRING`: MongoDBè¿žæŽ¥å­—ç¬¦ä¸²
        - `MDB_DB`: é»˜è®¤æ•°æ®åº“åç§° (é»˜è®¤: ChatBI)
        
        ### 5. éªŒè¯è¿è¡ŒçŠ¶æ€
        ```bash
        # æ£€æŸ¥å®¹å™¨çŠ¶æ€
        docker ps
        
        # æŸ¥çœ‹å®¹å™¨æ—¥å¿—
        docker logs <container_id>
        ```
        EOF
        
    - name: Upload download instructions
      uses: actions/upload-artifact@v4
      with:
        name: download-instructions-${{ steps.meta.outputs.version }}
        path: download-instructions.md
        retention-days: 30
        
    - name: Comment download link on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: runId } = await github.rest.actions.getWorkflowRun({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId
          });
          
          const artifactUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          
          const comment = `## ðŸ³ Docker é•œåƒæž„å»ºå®Œæˆ
          
**é•œåƒä¿¡æ¯:**
- ç‰ˆæœ¬: \`${{ steps.meta.outputs.version }}\`
- æž¶æž„: \`linux/amd64\`
- æ–‡ä»¶å¤§å°: \`${{ steps.image_info.outputs.size }}\`

**ä¸‹è½½é“¾æŽ¥:**
[ðŸ“¦ ä¸‹è½½ Docker é•œåƒ](${artifactUrl})

**ä½¿ç”¨æ–¹æ³•:**
1. ä»Žä¸Šé¢çš„é“¾æŽ¥ä¸‹è½½ \`${{ steps.image_info.outputs.filename }}\`
2. è§£åŽ‹å¹¶åŠ è½½é•œåƒï¼š
   \`\`\`bash
   gunzip ${{ steps.image_info.outputs.filename }}
   docker load -i mongodb-mcp-server-${{ steps.meta.outputs.version }}-amd64.tar
   \`\`\`
3. è¿è¡Œå®¹å™¨ï¼š
   \`\`\`bash
   docker run -d -p 8000:8000 \\
     -e MDB_MCP_CONNECTION_STRING="your_mongodb_connection_string" \\
     mongodb-mcp-server:${{ steps.meta.outputs.version }}
   \`\`\``;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: Create release notes
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cat > release-notes.md << 'EOF'
        # MongoDB MCP Server ${{ steps.meta.outputs.version }}
        
        ## Docker é•œåƒä¸‹è½½
        
        **é•œåƒä¿¡æ¯:**
        - æž¶æž„: linux/amd64
        - æ–‡ä»¶å¤§å°: ${{ steps.image_info.outputs.size }}
        
        **ä¸‹è½½æ–‡ä»¶:**
        - [${{ steps.image_info.outputs.filename }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        
        **å¿«é€Ÿå¼€å§‹:**
        ```bash
        # ä¸‹è½½å¹¶è§£åŽ‹é•œåƒ
        gunzip ${{ steps.image_info.outputs.filename }}
        
        # åŠ è½½åˆ°Docker
        docker load -i mongodb-mcp-server-${{ steps.meta.outputs.version }}-amd64.tar
        
        # è¿è¡ŒæœåŠ¡
        docker run -d -p 8000:8000 \
          -e MDB_MCP_CONNECTION_STRING="mongodb://user:pass@host:port/database" \
          mongodb-mcp-server:${{ steps.meta.outputs.version }}
        ```
        
        ## æ›´æ–°å†…å®¹
        è¯·æŸ¥çœ‹æäº¤åŽ†å²äº†è§£æœ¬ç‰ˆæœ¬çš„å…·ä½“æ›´æ–°å†…å®¹ã€‚
        EOF
        
    - name: Upload release notes
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: release-notes-${{ steps.meta.outputs.version }}
        path: release-notes.md
        retention-days: 90 